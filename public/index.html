<!DOCTYPE html>
<html>
<head>
    <title>Your App</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quilljs-markdown@latest/dist/quilljs-markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.0.0/dist/turndown.js"></script>
    <style>
        @font-face {
            font-family: 'ArminRegular';
            src: url('/fonts/ArminSoft-Regular.ttf');
        }

        body {
            display: flex;
            margin: 0;
            font-family: ArminRegular; 
            font-size: smaller;
        }

        .parent {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 50px 3fr;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
            width: 100vw;
            height: 100vh;
        }

        .div1 {
            grid-area: 1 / 1 / 2 / 3;
            background-color: #89c6b8;
            font-size: large;
            font-weight: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            width: 100%;
            height: 50px;
            z-index: 1;}
        .div2 { grid-area: 2 / 1 / 3 / 2; background-color: #fef7ea; padding: 15px;
        position: fixed;
        top: 50px;
        height: -webkit-fill-available;
        width: 250px;}
        .div3 { grid-area: 2 / 2 / 3 / 3; }

        #breadcrumb
        {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item{
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .breadcrumb-item:hover{
            background-color: #a9d6cc;
        }

        #main-content
        {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #article
        {
            width: 100%;
            max-width: 750px;
        }

        .ql-container
        {
            font-size: medium;
        }

        .ql-container.ql-bubble
        {
            border: none;
            font-family: ArminRegular;
        }

        .folder, .file
        {
            list-style-type: none;
            cursor: pointer;
            padding: 3px;
            margin: 1px 0;
            border-radius: 3px;
        }

        .folder:hover, .file:hover
        {
            background-color: #ffe9c0;
        }

        #new-buttons
        {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .new-button
        {
            height: 30px;
            font-family: ArminRegular;
            background-color: #fef7ea;
            padding: 8px;
            border: none;
            border-radius: 5px;
            line-height: 100%;
            flex-grow: 1;
        }

        #new-folder-text, #new-article-text
        {
            width: 100%;
            border: none;
            background-color: none;
        }

        #new-folder-text:focus-visible, #new-article-text:focus-visible
        {
            outline: none;
        }

        .new-button:hover
        {
            background-color: #ffe9c0;
        }

        .new-button-confirm
        {
            background-color: #FFF;
            border: none;
            display: flex;
            width: 20px;
            justify-content: center;
        }

        #new-folder-form, #new-article-form
        {
            background-color: #FFF;
            padding: 3px;
            border: 2px solid #ffe9c0;
            border-radius: 5px;
            margin: 3px 0;
        }

        #search-box
        {
            display: none;
        }

        #search-box input
        {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 2px solid #CCC;
            border-radius: 10px;
            outline: none;
        }

        #search-results ul {
            padding: 0;
        }

        #search-results ul li{
            list-style-type: none;
            padding: 3px;
            margin: 1px 0;
            border-radius: 3px;
        }

        #search-results ul li a{
            text-decoration: none;
            color: black;
        }


        #search-results ul li:hover{
            background-color: #ffe9c0;
        }

        .topbar-button
        {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 5px;
            cursor: pointer;
        }

        .topbar-button:hover
        {
            background-color: #a9d6cc;
        }

        .ql-editor[contenteditable=true]
        {
            
            border-radius: 15px;
            background-image: linear-gradient(45deg, #ffffdb 25%, #ffffe3 25%, #ffffe3 50%, #ffffdb 50%, #ffffdb 75%, #ffffe3 75%, #ffffe3 100%);
            background-size: 56.57px 56.57px;
        }

        #article-edit-buttons
        {
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 50px;
            right: 0px;
            z-index: 1;
        }
        #article-edit-buttons button
        {
            height: 30px;
            font-family: ArminRegular;
            background-color: #fef7ea;
            padding: 8px;
            border: none;
            border-radius: 5px;
            line-height: 100%;
            flex-grow: 1;
            margin: 5px 10px;
            border: 2px solid #ffd077;
        }

        #enable-editor:hover
        {
            background-color: #ffe9c0;
        }

        #cancel-changes:hover
        {
            background-color: #ffc0c0;
        }

        .ql-editor h1{
            border-bottom: 2px solid #AAA;
            margin-bottom: 10px;
        }
        .ql-editor h2 {
            border-bottom: 1px solid #AAA;
            margin-bottom: 10px;
        }

        .ql-bubble .ql-editor img
        {
            max-width: 100%;
        }
    </style>
    
</head>
<body>
    <div class="parent">
        <div class="div1">
            <div id="breadcrumb"></div>
            <div id="topbar-links">
                <div id="search-link" class="topbar-button">üîç</div>
            </div>
        </div>
        <div class="div2">
            <div id="file-view">
            <div id="new-buttons">
                <input type="button" id="new-folder" class="new-button" value="New Folder">
                <input type="button" id="new-article" class="new-button" value="New Article">
            </div>
            <form id="new-folder-form" style="display: none;">
                üìÇ
                <input type="text" id="new-folder-text" required>
                <input type="submit" id="new-folder-save" class="new-button-confirm" value="‚úîÔ∏è">
                <input type="button" id="new-folder-cancel" class="new-button-confirm" value="‚ùå" onclick="document.getElementById('new-folder-form').style.display = 'none'">
            </form>
            <form id="new-article-form" style="display: none;">
                üìÉ
                <input type="text" id="new-article-text" required>
                <input type="submit" id="new-article-save" class="new-button-confirm" value="‚úîÔ∏è">
                <input type="button" id="new-article-cancel" class="new-button-confirm" value="‚ùå" onclick="document.getElementById('new-folder-form').style.display = 'none'">
            </form>
            <div id="file-tree"></div>
            </div>
            <div id="search-box">
                <input type="text" id="search-input">
                <div id="search-results"></div>
            </div>
        </div>
        <div class="div3">
            <div id="main-content">
                <div id="article">
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let fileTreeData;
        let editor;
        let currentPath = '';

        socket.on('fileTree', (tree) => {
            fileTreeData = tree;
            updateBreadcrumb(['Content']);
            updateFileTree(tree.children);
            openFolder(currentPath);
        });

        // Declare editor in a broader scope
        let cachedContent; // Variable to cache the original content

socket.on('fileContent', (content) => {
    document.getElementById('article').innerHTML = `
        <div id="article-edit-buttons">
        <button id="enable-editor">Edit this page</button>
        <button id="cancel-changes" style="display:none;">Discard Changes</button>
        </div>
        <div id="editor"></div>`;

    cachedContent = content; // Cache the original content

    const editButton = document.getElementById('enable-editor');
    const cancelButton = document.getElementById('cancel-changes');

    editButton.addEventListener('click', () => {
        const isEditing = editButton.textContent === 'Edit this page';
        toggleEditor();

        if (isEditing) {
            // Switch to 'Save Changes' mode
            editButton.textContent = 'Save Changes';
            cancelButton.style.display = 'inline'; // Show the discard button
        } else {
            // Save changes
            const turndownService = new TurndownService();
            const markdown = turndownService.turndown(editor.root.innerHTML);
            socket.emit('saveFileContent', { filePath: currentFilePath, content: markdown });
            editButton.textContent = 'Edit this page';
            cancelButton.style.display = 'none'; // Hide the discard button
        }
    });

    cancelButton.addEventListener('click', () => {
        // Discard changes and revert to original content
        const htmlContent = marked.parse(cachedContent);
        editor.setContents(editor.clipboard.convert(htmlContent));
        editButton.textContent = 'Edit this page';
        cancelButton.style.display = 'none';
        toggleEditor();
    });

    var toolbarOptions = [
                ['bold', 'italic', 'underline'],        // toggled buttons
                ['blockquote'],
                [{ 'header': 1 }, { 'header': 2 }],               // custom button values
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [ 'link', 'image', 'video', 'formula' ],
                ['clean']                                         // remove formatting button
            ];


            // Initialize Quill editor
            editor = new Quill('#editor', { modules: {
                toolbar: toolbarOptions
                },
            theme: 'bubble'
            });

            // Initialize QuillMarkdown if needed
            const markdownOptions = {
                theme: 'bubble'
            };

            const quillMarkdown = new QuillMarkdown(editor, markdownOptions);

            content = content.replace(/^\s{2}$/gm, '<br>')
            const htmlContent = marked.parse(content);
            console.log(content);
            console.log(htmlContent);
            editor.setContents(editor.clipboard.convert(htmlContent));

            toggleEditor();
        });

        socket.on('saveFileContentSuccess', (message) => {
            const success = document.createElement('div');
            success.style.position = 'fixed';
            success.style.right = '100px';
            success.style.top = '13px';
            success.style.backgroundColor = '#4CAF50'; // Green background
            success.style.color = 'white'; // White text
            success.style.padding = '5px';
            success.style.borderRadius = '5px';
            success.style.zIndex = '1000'; // Ensure it's on top
            success.textContent = 'Saved!'; // Set the text content

            document.body.appendChild(success);

            // Optional: Remove the message after a few seconds
            setTimeout(() => {
                document.body.removeChild(success);
            }, 3000); // 3 seconds delay
        });

        socket.on('saveFileContentError', (errorMessage) => {
            alert(errorMessage); // or update the UI accordingly
        });

        function toggleEditor() {
            const isReadOnly = !editor.isEnabled();
            editor.enable(isReadOnly);
        }

        socket.on('fileContentError', (errorMessage) => {
            document.getElementById('main-content').textContent = errorMessage;
        });

        function updateFileTree(nodes, path = '') {
            const treeElement = document.getElementById('file-tree');

            // Sort nodes: directories first, then files, both alphabetically
            nodes.sort((a, b) => {
                if (a.type === b.type) {
                    // If both are files or both are directories, sort alphabetically
                    return a.name.localeCompare(b.name);
                } else {
                    // Directories come before files
                    return a.type === 'directory' ? -1 : 1;
                }
            });

            treeElement.innerHTML = nodes.map(node => createTreeHtml(node, path)).join('');
        }

        function createTreeHtml(node, parentPath) {
            const currentPath = parentPath ? `${parentPath}/${node.name}` : node.name;

            if (node.type === 'directory') {
                return `<li class="folder" onclick="openFolder('${currentPath}', '${node.name}')">üìÇ ${node.name}</li>`;
            } else {
                cleanName = node.name.replace('.md', '');
                return `<li class="file" onclick="loadFileContent('${currentPath}')">üìÉ ${cleanName}</li>`; 
            }
        }


        function openFolder(pathString, folderName) {
            closeSearch();
            currentPath = pathString;
            const path = pathString.split('/').filter(Boolean);

            // Special handling for the root level
            if (pathString === 'Content' || path.length === 0) {
                updateBreadcrumb(['üè† Home']);
                updateFileTree(fileTreeData.children, '');
                return;
            }

            const folder = findFolder(fileTreeData, path);
            console.log('Path:', path, 'Folder:', folder);

            if (folder) {
                updateBreadcrumb(['üè† Home', ...path]);
                updateFileTree(folder.children, path.join('/'));
            } else {
                console.error('Folder not found for path:', path);
            }
        }

        function updateBreadcrumb(pathParts) {
            const breadcrumbElement = document.getElementById('breadcrumb');
            let fullPath = '';
            breadcrumbElement.innerHTML = pathParts.map((part, index) => {
                // Skip 'Content' when building the fullPath
                if (index > 0) {
                    fullPath += (index > 1 ? '/' : '') + part;
                }

                // Correctly call openFolder with the necessary path
                const pathForFunction = index === 0 ? '' : fullPath;

                return `<div class="breadcrumb-item" onclick="openFolder('${pathForFunction}', '${part}')">${part}</div>`;
            }).join(' > ');
        }

        function findFolder(node, pathParts) {
            for (const part of pathParts) {
                if (node.type !== 'directory') {
                    return null;
                }
                node = node.children.find(child => child.name === part);
                if (!node) {
                    return null;
                }
            }
            return node;
        }

        function loadFileContent(filePath) {
            currentFilePath = filePath; // Update the current file path
            socket.emit('requestFileContent', filePath);
        }

        document.getElementById('new-folder').addEventListener('click', () => {
            document.getElementById('new-article-form').style.display = 'none';
            document.getElementById('new-article-text').value = '';
            document.getElementById('new-folder-form').style.display = 'flex';
        });
        document.getElementById('new-article').addEventListener('click', () => {
            document.getElementById('new-folder-form').style.display = 'none';
            document.getElementById('new-folder-text').value = '';
            document.getElementById('new-article-form').style.display = 'flex';
        });

        document.getElementById('new-folder-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submit action

            // Get the value from the input field
            var folderName = document.getElementById('new-folder-text').value;

            // Ensure the folder name is not empty
            if (folderName.trim() === '') {
                alert('Please enter a folder name.');
                return;
            }

            // Construct the full path for the new folder
            const fullPath = currentPath ? `${currentPath}/${folderName}` : folderName;

            // Use the full path in your socket.emit call
            socket.emit('createFolder', fullPath);

            // Optionally, clear the input field after submission
            document.getElementById('new-folder-text').value = '';
            document.getElementById('new-folder-form').style.display = 'none';
        });

        document.getElementById('new-article-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submit action

            // Get the value from the input field
            var articleName = document.getElementById('new-article-text').value;

            // Ensure the article name is not empty
            if (articleName.trim() === '') {
                alert('Please enter an article name.');
                return;
            }

            // Add the .md extension and construct the full path for the new article
            const fullPath = currentPath ? `${currentPath}/${articleName}.md` : `${articleName}.md`;

            // Use the full path in your socket.emit call
            socket.emit('createArticle', fullPath);

            // Optionally, clear the input field after submission
            document.getElementById('new-article-text').value = '';
            document.getElementById('new-article-form').style.display = 'none';
        });

        document.getElementById('search-link').addEventListener('click', () => {
            document.getElementById('file-view').style = 'display: none;';
            document.getElementById('search-box').style = 'display: block;';
            document.getElementById('search-input').focus();
        });

        document.getElementById('search-input').addEventListener('input', () => {
            const query = document.getElementById('search-input').value;
            socket.emit('search', query);
        });

        socket.on('searchResults', (results) => {
            console.log(results);
            displaySearchResults(results);
        });

        function closeSearch() {
            document.getElementById('file-view').style = 'display: block;';
            document.getElementById('search-box').style = 'display: none;';
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';

        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = ''; // Clear previous results

            // Access the results array
            const searchResults = results.RESULT || [];

            if (searchResults.length === 0) {
                resultsDiv.innerHTML = '<p>No results found.</p>';
                return;
            }

            const resultList = document.createElement('ul');

            searchResults.forEach(result => {
                const resultItem = document.createElement('li');
                resultItem.style.cursor = 'pointer';
                resultItem.title = result._id;

                // Create a link element
                const link = document.createElement('div');
                const path = document.createElement('div');
                path.style.fontSize = 'smaller';
                path.style.color = '#777';
                path.innerHTML = result._id;
                link.innerHTML = 'üìÉ' + result._doc.filename.replace(/\.md$/, ''); // Filename without .md extension
                resultItem.onclick = (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    loadFileContent(result._id); // Function to load and display file content
                };

                resultItem.appendChild(link);
                resultItem.appendChild(path);
                resultList.appendChild(resultItem);
            });

            resultsDiv.appendChild(resultList);
        }
    </script>
</body>
</html>
