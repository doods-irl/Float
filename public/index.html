<!DOCTYPE html>
<html>
<head>
    <title>Your App</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quilljs-markdown@latest/dist/quilljs-markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.0.0/dist/turndown.js"></script>
    <style>
        @font-face {
            font-family: 'ArminRegular';
            src: url('/fonts/ArminSoft-Regular.ttf');
        }

        body {
            display: flex;
            margin: 0;
            font-family: ArminRegular; 
            font-size: smaller;
        }

        .parent {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 50px 3fr;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
            width: 100vw;
            height: 100vh;
        }

        .div1 { grid-area: 1 / 1 / 2 / 3; background-color: #89c6b8; padding: 0 20px; font-size: large; font-weight: 1000; display: flex; align-items: center;}
        .div2 { grid-area: 2 / 1 / 3 / 2; background-color: #fef7ea; padding: 15px;}
        .div3 { grid-area: 2 / 2 / 3 / 3; }

        #breadcrumb
        {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item{
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .breadcrumb-item:hover{
            background-color: #a9d6cc;
        }

        #main-content
        {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #article
        {
            width: 100%;
            max-width: 650px;
        }

        .ql-container.ql-bubble
        {
            border: none;
            font-family: ArminRegular;
        }

        .folder, .file
        {
            list-style-type: none;
            cursor: pointer;
            padding: 3px;
            margin: 1px 0;
            border-radius: 3px;
        }

        .folder:hover, .file:hover
        {
            background-color: #ffe9c0;
        }

        #new-buttons
        {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .new-button
        {
            height: 30px;
            font-family: ArminRegular;
            background-color: #fef7ea;
            padding: 8px;
            border: none;
            border-radius: 5px;
            line-height: 100%;
            flex-grow: 1;
        }

        #new-folder-text, #new-article-text
        {
            width: 100%;
            border: none;
            background-color: none;
        }

        #new-folder-text:focus-visible, #new-article-text:focus-visible
        {
            outline: none;
        }

        .new-button:hover
        {
            background-color: #ffe9c0;
        }

        .new-button-confirm
        {
            background-color: #FFF;
            border: none;
            display: flex;
            width: 20px;
            justify-content: center;
        }

        #new-folder-form, #new-article-form
        {
            background-color: #FFF;
            padding: 3px;
            border: 2px solid #ffe9c0;
            border-radius: 5px;
            margin: 3px 0;
        }
    </style>
    
</head>
<body>
    <div class="parent">
        <div class="div1"><div id="breadcrumb"></div></div>
        <div class="div2">
            <div id="new-buttons">
                <input type="button" id="new-folder" class="new-button" value="New Folder">
                <input type="button" id="new-article" class="new-button" value="New Article">
            </div>
            <form id="new-folder-form" style="display: none;">
                ðŸ“‚
                <input type="text" id="new-folder-text" required>
                <input type="submit" id="new-folder-save" class="new-button-confirm" value="âœ”ï¸">
                <input type="button" id="new-folder-cancel" class="new-button-confirm" value="âŒ" onclick="document.getElementById('new-folder-form').style.display = 'none'">
            </form>
            <form id="new-article-form" style="display: none;">
                ðŸ“ƒ
                <input type="text" id="new-article-text" required>
                <input type="submit" id="new-article-save" class="new-button-confirm" value="âœ”ï¸">
                <input type="button" id="new-article-cancel" class="new-button-confirm" value="âŒ" onclick="document.getElementById('new-folder-form').style.display = 'none'">
            </form>
            <div id="file-tree"></div>
        </div>
        <div class="div3">
            <div id="main-content">
                <div id="article">
                </div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let fileTreeData;
        let editor;
        let currentPath = '';

        socket.on('fileTree', (tree) => {
            fileTreeData = tree;
            updateBreadcrumb(['Content']);
            updateFileTree(tree.children);
            openFolder(currentPath);
        });

        // Declare editor in a broader scope
        

        socket.on('fileContent', (content) => {
            console.log(content);
            document.getElementById('article').innerHTML = `<button id="save-article">Save Article</button>
                            <div id="editor"></div>`;

            document.getElementById('save-article').addEventListener('click', () => {
                const turndownService = new TurndownService();
                const markdown = turndownService.turndown(editor.root.innerHTML);

                socket.emit('saveFileContent', { filePath: currentFilePath, content: markdown });
            });

            const options = {
                theme: 'bubble', // or other Quill theme
                // ... other Quill options
            };

            // Initialize Quill editor
            editor = new Quill('#editor', options);

            // Initialize QuillMarkdown if needed
            const markdownOptions = {
                // Your markdown options
            };

            const quillMarkdown = new QuillMarkdown(editor, markdownOptions);
            const htmlContent = marked.parse(content);
            // Set content
            editor.setContents(editor.clipboard.convert(htmlContent));
        });

        socket.on('saveFileContentSuccess', (message) => {
            alert(message); // or update the UI accordingly
        });

        socket.on('saveFileContentError', (errorMessage) => {
            alert(errorMessage); // or update the UI accordingly
        });

        function toggleEditor() {
            const isReadOnly = !editor.isEnabled();
            editor.enable(isReadOnly);

            // Get the toolbar element. Adjust the selector if necessary.
            const toolbar = document.querySelector('.ql-toolbar');

            if (toolbar) {
                toolbar.style.display = isReadOnly ? 'block' : 'none'; // Hide toolbar if editor is read-only
            }
        }

        socket.on('fileContentError', (errorMessage) => {
            document.getElementById('main-content').textContent = errorMessage;
        });

        function updateFileTree(nodes, path = '') {
            const treeElement = document.getElementById('file-tree');

            // Sort nodes: directories first, then files, both alphabetically
            nodes.sort((a, b) => {
                if (a.type === b.type) {
                    // If both are files or both are directories, sort alphabetically
                    return a.name.localeCompare(b.name);
                } else {
                    // Directories come before files
                    return a.type === 'directory' ? -1 : 1;
                }
            });

            treeElement.innerHTML = nodes.map(node => createTreeHtml(node, path)).join('');
        }

        function createTreeHtml(node, parentPath) {
            const currentPath = parentPath ? `${parentPath}/${node.name}` : node.name;

            if (node.type === 'directory') {
                return `<li class="folder" onclick="openFolder('${currentPath}', '${node.name}')">ðŸ“‚ ${node.name}</li>`;
            } else {
                // Pass the path to the file, not the content
                return `<li class="file" onclick="loadFileContent('${currentPath}')">ðŸ“ƒ ${node.name}</li>`; 
            }
        }


        function openFolder(pathString, folderName) {
            currentPath = pathString;
            const path = pathString.split('/').filter(Boolean);

            // Special handling for the root level
            if (pathString === 'Content' || path.length === 0) {
                updateBreadcrumb(['Content']);
                updateFileTree(fileTreeData.children, '');
                return;
            }

            const folder = findFolder(fileTreeData, path);
            console.log('Path:', path, 'Folder:', folder);

            if (folder) {
                updateBreadcrumb(['Content', ...path]);
                updateFileTree(folder.children, path.join('/'));
            } else {
                console.error('Folder not found for path:', path);
            }
        }

        function openFolderFromBreadcrumb(fullPath) {
            // Split the path and remove the 'Content' part
            const pathParts = fullPath.split('/').filter(part => part !== 'Content');
            console.log(pathParts);
            openFolder(pathParts.join('/'), pathParts[pathParts.length - 1]);
        }

        function updateBreadcrumb(pathParts) {
            const breadcrumbElement = document.getElementById('breadcrumb');
            let fullPath = '';
            breadcrumbElement.innerHTML = pathParts.map((part, index) => {
                // Skip 'Content' when building the fullPath
                if (index > 0) {
                    fullPath += (index > 1 ? '/' : '') + part;
                }

                // Correctly call openFolder with the necessary path
                const pathForFunction = index === 0 ? '' : fullPath;

                return `<div class="breadcrumb-item" onclick="openFolder('${pathForFunction}', '${part}')">${part}</div>`;
            }).join(' > ');
        }

        function findFolder(node, pathParts) {
            for (const part of pathParts) {
                if (node.type !== 'directory') {
                    return null;
                }
                node = node.children.find(child => child.name === part);
                if (!node) {
                    return null;
                }
            }
            return node;
        }

        function loadFileContent(filePath) {
            currentFilePath = filePath; // Update the current file path
            socket.emit('requestFileContent', filePath);
        }

        document.getElementById('new-folder').addEventListener('click', () => {
            document.getElementById('new-article-form').style.display = 'none';
            document.getElementById('new-article-text').value = '';
            document.getElementById('new-folder-form').style.display = 'flex';
        });
        document.getElementById('new-article').addEventListener('click', () => {
            document.getElementById('new-folder-form').style.display = 'none';
            document.getElementById('new-folder-text').value = '';
            document.getElementById('new-article-form').style.display = 'flex';
        });

        document.getElementById('new-folder-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submit action

            // Get the value from the input field
            var folderName = document.getElementById('new-folder-text').value;

            // Ensure the folder name is not empty
            if (folderName.trim() === '') {
                alert('Please enter a folder name.');
                return;
            }

            // Construct the full path for the new folder
            const fullPath = currentPath ? `${currentPath}/${folderName}` : folderName;

            // Use the full path in your socket.emit call
            socket.emit('createFolder', fullPath);

            // Optionally, clear the input field after submission
            document.getElementById('new-folder-text').value = '';
            document.getElementById('new-folder-form').style.display = 'none';
        });

        document.getElementById('new-article-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submit action

            // Get the value from the input field
            var articleName = document.getElementById('new-article-text').value;

            // Ensure the article name is not empty
            if (articleName.trim() === '') {
                alert('Please enter an article name.');
                return;
            }

            // Add the .md extension and construct the full path for the new article
            const fullPath = currentPath ? `${currentPath}/${articleName}.md` : `${articleName}.md`;

            // Use the full path in your socket.emit call
            socket.emit('createArticle', fullPath);

            // Optionally, clear the input field after submission
            document.getElementById('new-article-text').value = '';
            document.getElementById('new-article-form').style.display = 'none';
        });

        
    </script>
</body>
</html>
